---
title: Upsert behavior
description: Learn how Greenseed handles conflict resolution with insert-only and upsert modes
---

Greenseed provides two strategies for handling primary key conflicts when seeding data: **insert-only** (do nothing on conflict) and **upsert** (update on conflict).

## How it works

When Greenseed inserts rows into your database, it uses PostgreSQL's `ON CONFLICT` clause to handle duplicate primary keys. The behavior depends on whether you configure the `updateOnConflict` option in your seed configuration.

### Insert-only mode (do nothing)

When `updateOnConflict` is not specified or is an empty array, Greenseed will skip rows that conflict with existing data.

<Tabs>
  <Tab title="Configuration">
    ```json
    {
      "tables": [
        {
          "table": "users",
          "schema": "public",
          "primaryKeys": ["id"],
          "source": "./data/users.json"
        }
      ]
    }
    ```
  </Tab>
  <Tab title="Generated SQL">
    ```sql
    INSERT INTO public.users (id, name, email)
    VALUES (1, 'Alice', 'alice@example.com')
    ON CONFLICT (id) DO NOTHING
    RETURNING id;
    ```
  </Tab>
</Tabs>

<Note>
  In insert-only mode, if a row with the same primary key already exists, it will be silently skipped. The existing row remains unchanged.
</Note>

### Upsert mode (do update)

When `updateOnConflict` contains column names, Greenseed will update those columns when a conflict occurs.

<Tabs>
  <Tab title="Configuration">
    ```json
    {
      "tables": [
        {
          "table": "users",
          "schema": "public",
          "primaryKeys": ["id"],
          "source": "./data/users.json",
          "updateOnConflict": ["name", "email", "updated_at"]
        }
      ]
    }
    ```
  </Tab>
  <Tab title="Generated SQL">
    ```sql
    INSERT INTO public.users (id, name, email, updated_at)
    VALUES (1, 'Alice Smith', 'alice@example.com', '2026-02-28')
    ON CONFLICT (id) DO UPDATE SET
      name = EXCLUDED.name,
      email = EXCLUDED.email,
      updated_at = EXCLUDED.updated_at
    RETURNING id;
    ```
  </Tab>
</Tabs>

<Tip>
  The `EXCLUDED` keyword in PostgreSQL refers to the row that was proposed for insertion. This allows you to reference the new values in your update clause.
</Tip>

## Primary key filtering

Greenseed automatically filters out primary key columns from the update set. Even if you include primary keys in `updateOnConflict`, they will be removed to prevent conflicts.

```json
{
  "primaryKeys": ["id"],
  "updateOnConflict": ["id", "name", "email"]
}
```

<Warning>
  The `id` column will be automatically removed from the update set since it's a primary key. Only `name` and `email` will be updated on conflict.
</Warning>

## When to use each mode

### Use insert-only when:

- You want to preserve existing data and only add new rows
- Running seeds multiple times for idempotency without data changes
- Seeding reference data that shouldn't change once created
- Testing scenarios where you want to avoid accidental data overwrites

### Use upsert mode when:

- You need to update existing rows with new values
- Synchronizing data from an external source
- Maintaining seed files as the source of truth
- Running migrations that both create and update records

## Composite primary keys

Greenseed supports composite primary keys (multiple columns). The conflict target will include all primary key columns.

```json
{
  "table": "product_prices",
  "primaryKeys": ["product_id", "region_id"],
  "updateOnConflict": ["price", "currency", "updated_at"]
}
```

Generated SQL:

```sql
INSERT INTO public.product_prices (product_id, region_id, price, currency, updated_at)
VALUES (101, 'US', 29.99, 'USD', '2026-02-28')
ON CONFLICT (product_id, region_id) DO UPDATE SET
  price = EXCLUDED.price,
  currency = EXCLUDED.currency,
  updated_at = EXCLUDED.updated_at
RETURNING product_id;
```

## Return count

Greenseed reports the number of rows actually inserted or updated. Rows skipped due to conflicts (in insert-only mode) are not counted.

```bash
✓ public.users inserted 150 rows
✓ public.products upserted 200 rows
✓ public.categories inserted 15, skipped 5
```

<Note>
  The return count is based on the `RETURNING` clause, which only returns rows that were actually inserted or updated.
</Note>
